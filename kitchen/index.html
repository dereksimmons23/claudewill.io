<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>kitchen | claudewill*</title>
  <meta name="robots" content="noindex, nofollow">

  <link rel="icon" type="image/svg+xml" href="/favicon-cw-dark.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/shared-nav.css">
  <link rel="stylesheet" href="/css/kitchen.css">
  <link rel="stylesheet" href="/css/porch-widget.css">
</head>
<body class="kitchen-page">

  <!-- Auth Gate -->
  <div id="kitchen-gate" class="kitchen-gate">
    <div class="kitchen-gate-inner">
      <div class="kitchen-gate-label">cw> kitchen</div>
      <p class="kitchen-gate-sub">private entrance</p>
      <input
        id="kitchen-code-input"
        type="password"
        autocomplete="off"
        placeholder="code"
        maxlength="32"
      >
      <div id="kitchen-error" class="kitchen-error"></div>
    </div>
  </div>

  <!-- Dashboard (hidden until auth) -->
  <div id="kitchen-dashboard" class="kitchen-dashboard" style="display: none;">

    <header class="page-header" id="page-header">
      <a href="/" class="page-header-left"><span class="header-short">cw</span><span class="header-full">claudewill</span><span class="hw">*</span></a>
      <div class="page-header-center">
        <span class="kitchen-page-label">the kitchen</span>
      </div>
      <button class="page-header-right palette-trigger" aria-label="Open navigation">menu</button>
    </header>

    <div class="container">
      <main>
        <div class="kitchen-toolbar">
          <div class="kitchen-status">
            <span class="kitchen-status-dot"></span>
            <span id="kitchen-status-text">live</span>
          </div>
          <button id="kitchen-refresh" class="kitchen-refresh-btn">refresh</button>
        </div>

        <div class="kitchen-grid">

          <section class="kitchen-panel" id="panel-brief">
            <h2 class="panel-title">the brief*</h2>
            <div class="panel-body loading" id="brief-content">loading brief...</div>
          </section>

          <section class="kitchen-panel" id="panel-pulse">
            <h2 class="panel-title">the pulse*</h2>
            <div class="panel-body loading" id="pulse-content">loading metrics...</div>
          </section>

          <section class="kitchen-panel" id="panel-content">
            <h2 class="panel-title">content stage*</h2>
            <div class="panel-body loading" id="content-content">loading calendar...</div>
          </section>

          <section class="kitchen-panel" id="panel-decisions">
            <h2 class="panel-title">decisions queue*</h2>
            <div class="panel-body loading" id="decisions-content">loading queue...</div>
          </section>

        </div>
      </main>

      <footer>
        <p class="footer-note">Built by <a href="/derek">Derek</a><span class="hw">*</span><a href="/">Claude</a> &middot; &copy; 2026 CW Strategies LLC</p>
        <p class="footer-note"><a href="/story#the-cw-standard">the standard</a> &middot; <a href="/privacy">privacy</a> &middot; <a href="/terms">terms</a></p>
      </footer>
    </div>

  </div>

  <!-- Kitchen Scripts -->
  <script>
  (function () {
    'use strict';

    var gate = document.getElementById('kitchen-gate');
    var dashboard = document.getElementById('kitchen-dashboard');
    var codeInput = document.getElementById('kitchen-code-input');
    var errorEl = document.getElementById('kitchen-error');
    var refreshBtn = document.getElementById('kitchen-refresh');

    function getCode() {
      return sessionStorage.getItem('cw-kitchen-code') || '';
    }

    function verifyCode(code) {
      return fetch('/.netlify/functions/kitchen-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'verify', kitchenCode: code })
      }).then(function (res) {
        return res.ok;
      }).catch(function () {
        return false;
      });
    }

    function showDashboard() {
      gate.style.display = 'none';
      dashboard.style.display = 'block';
      loadDashboard();
    }

    function showGate(msg) {
      gate.style.display = 'flex';
      dashboard.style.display = 'none';
      if (msg) errorEl.textContent = msg;
      sessionStorage.removeItem('cw-kitchen-code');
    }

    var existingCode = getCode();
    if (existingCode) {
      verifyCode(existingCode).then(function (ok) {
        if (ok) showDashboard();
        else showGate('');
      });
    }

    codeInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        var code = codeInput.value.trim();
        if (!code) return;
        errorEl.textContent = '';
        verifyCode(code).then(function (ok) {
          if (ok) {
            sessionStorage.setItem('cw-kitchen-code', code);
            showDashboard();
          } else {
            errorEl.textContent = 'wrong key.';
            codeInput.value = '';
            codeInput.focus();
          }
        });
      }
    });

    if (codeInput && !existingCode) codeInput.focus();

    // Dashboard data loading
    function loadDashboard() {
      var code = getCode();
      if (!code) return showGate('Session expired.');

      fetch('/.netlify/functions/kitchen-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'all', kitchenCode: code })
      })
      .then(function (res) {
        if (res.status === 401) { showGate('Session expired.'); return null; }
        return res.json();
      })
      .then(function (data) {
        if (!data) return;
        renderBrief(data.panels.brief);
        renderPulse(data.panels.pulse);
        renderContent(data.panels.content);
        renderDecisions(data.panels.decisions);
      })
      .catch(function () {
        setPanel('brief-content', 'error', 'Failed to load. Try refreshing.');
      });
    }

    // Safe DOM helpers â€” no innerHTML, prevents XSS
    function clearEl(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function setPanel(id, cls, text) {
      var el = document.getElementById(id);
      if (!el) return;
      el.className = 'panel-body' + (cls ? ' ' + cls : '');
      clearEl(el);
      el.textContent = text;
    }

    function createDiv(className, textContent) {
      var div = document.createElement('div');
      if (className) div.className = className;
      if (textContent !== undefined) div.textContent = textContent;
      return div;
    }

    function createSpan(className, textContent) {
      var span = document.createElement('span');
      if (className) span.className = className;
      if (textContent !== undefined) span.textContent = textContent;
      return span;
    }

    // Panel renderers using safe DOM methods
    function renderBrief(brief) {
      var el = document.getElementById('brief-content');
      el.className = 'panel-body';
      clearEl(el);

      if (typeof brief === 'string' && brief) {
        var pre = createDiv('brief-text', brief);
        el.appendChild(pre);
      } else if (brief && typeof brief === 'object') {
        var pre2 = createDiv('brief-text', JSON.stringify(brief, null, 2));
        el.appendChild(pre2);
      } else {
        el.appendChild(createDiv('empty-state', 'No brief available. Worker may be offline.'));
      }
    }

    function renderPulse(pulse) {
      var el = document.getElementById('pulse-content');
      el.className = 'panel-body';
      clearEl(el);

      if (!pulse || pulse.total === '\u2014') {
        el.appendChild(createDiv('empty-state', 'Pulse data unavailable.'));
        return;
      }

      el.appendChild(makeStatRow('total conversations', pulse.total));
      el.appendChild(makeStatRow('last 24h messages', pulse.last24h.messages));
      el.appendChild(makeStatRow('last 24h sessions', pulse.last24h.sessions));
      el.appendChild(makeStatRow('last 7d messages', pulse.last7d.messages));
      el.appendChild(makeStatRow('last 7d sessions', pulse.last7d.sessions));
      el.appendChild(makeStatRow('avg/day', pulse.avgPerDay));
    }

    function makeStatRow(label, value) {
      var row = createDiv('pulse-stat');
      row.appendChild(createSpan('pulse-label', label));
      row.appendChild(createSpan('pulse-value', String(value)));
      return row;
    }

    function renderContent(content) {
      var el = document.getElementById('content-content');
      el.className = 'panel-body';
      clearEl(el);

      if (!content || content.note) {
        el.appendChild(createDiv('empty-state', content && content.note ? content.note : 'Content data unavailable.'));
        return;
      }

      if (content.lastPost) {
        var daysSince = Math.floor((Date.now() - new Date(content.lastPost).getTime()) / (1000 * 60 * 60 * 24));
        var cls = daysSince <= 2 ? 'recent' : daysSince <= 5 ? 'due' : 'overdue';
        el.appendChild(makeContentRow('linkedin', daysSince + 'd ago', cls));
      } else {
        el.appendChild(makeContentRow('linkedin', 'no data', 'due'));
      }

      el.appendChild(makeContentRow('substack', 'check manually', 'due'));
      el.appendChild(makeContentRow('dispatches', '#3 due feb 24', ''));
    }

    function makeContentRow(platform, daysText, cls) {
      var row = createDiv('content-row');
      row.appendChild(createSpan('content-platform', platform));
      row.appendChild(createSpan('content-days' + (cls ? ' ' + cls : ''), daysText));
      return row;
    }

    function renderDecisions(decisions) {
      var el = document.getElementById('decisions-content');
      el.className = 'panel-body';
      clearEl(el);

      if (!decisions || !Array.isArray(decisions) || decisions.length === 0) {
        el.appendChild(createDiv('empty-state', 'Nothing in the queue. Clear pass.'));
        return;
      }

      for (var i = 0; i < decisions.length; i++) {
        var d = decisions[i];
        var item = createDiv('decision-item');
        item.appendChild(createDiv('decision-task', d.task || String(d)));
        if (d.criteria) {
          item.appendChild(createDiv('decision-meta', d.criteria));
        }
        el.appendChild(item);
      }
    }

    // Refresh handler
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function () {
        ['brief-content', 'pulse-content', 'content-content', 'decisions-content'].forEach(function (id) {
          setPanel(id, 'loading', 'refreshing...');
        });
        loadDashboard();
      });
    }

  })();
  </script>

  <!-- Auto-hide header on scroll -->
  <script>
    (function () {
      var header = document.getElementById('page-header');
      if (!header) return;
      var lastY = 0;
      window.addEventListener('scroll', function () {
        var y = window.scrollY;
        if (y > 80 && y > lastY) {
          header.classList.add('hidden');
        } else {
          header.classList.remove('hidden');
        }
        lastY = y;
      }, { passive: true });
    })();
  </script>

  <!-- CW Widget (Kitchen Mode) -->
  <script>
    window.CW_KITCHEN_CONFIG = {
      mode: 'kitchen',
      getCode: function () {
        return sessionStorage.getItem('cw-kitchen-code');
      },
      label: 'cw> kitchen',
      welcomeMessage: "Back of the house. What are we working on?"
    };
  </script>
  <script src="/js/cw-link-renderer.js"></script>
  <script src="/js/porch-widget.js" defer></script>
  <script src="/js/shared-nav.js"></script>

</body>
</html>
